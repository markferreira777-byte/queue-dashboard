<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Queue Monitor</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Inter+Tight:wght@600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg:        #080c12;
      --surface:   #0e1420;
      --surface2:  #141d2e;
      --border:    #1e2d45;
      --border2:   #263552;
      --blue:      #4d9fff;
      --green:     #2ed573;
      --yellow:    #ffd32a;
      --red:       #ff4757;
      --text:      #e8f0fe;
      --muted:     #5a7394;
      --muted2:    #7a96b8;
      --font-h:    'Inter Tight', sans-serif;
      --font-b:    'Inter', sans-serif;
      --radius:    14px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-b);
      min-height: 100vh;
      background-image: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(77,159,255,0.07) 0%, transparent 60%);
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 2.5rem; height: 64px;
      background: rgba(14,20,32,0.85);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 50;
    }
    .brand { display: flex; align-items: center; gap: 1rem; }
    .brand-icon {
      width: 34px; height: 34px; border-radius: 9px;
      background: linear-gradient(135deg, #4d9fff 0%, #2563eb 100%);
      display: flex; align-items: center; justify-content: center; font-size: 1rem;
      box-shadow: 0 0 20px rgba(77,159,255,0.3);
    }
    .brand-name { font-family: var(--font-h); font-size: 1.1rem; font-weight: 700; color: var(--text); }
    .brand-sub { font-size: 0.7rem; font-weight: 400; color: var(--muted); letter-spacing: 0.06em; text-transform: uppercase; margin-top: 1px; }
    .header-right { display: flex; align-items: center; gap: 1.25rem; }
    .clock { font-family: var(--font-h); font-size: 1rem; font-weight: 600; letter-spacing: 0.05em; color: var(--muted2); font-variant-numeric: tabular-nums; }
    .live-pill {
      display: flex; align-items: center; gap: 0.45rem;
      font-family: var(--font-h); font-size: 0.7rem; font-weight: 700;
      letter-spacing: 0.08em; text-transform: uppercase;
      padding: 0.3rem 0.9rem; border-radius: 20px; border: 1px solid; transition: all 0.4s;
    }
    .live-pill.live    { color: var(--green); border-color: rgba(46,213,115,0.4); background: rgba(46,213,115,0.08); }
    .live-pill.offline { color: var(--muted); border-color: var(--border); background: transparent; }
    .live-pill.error   { color: var(--red);   border-color: rgba(255,71,87,0.4);  background: rgba(255,71,87,0.08); }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
    .dot.pulse { animation: pulse 2s ease-in-out infinite; }
    @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.3;transform:scale(0.7)} }
    main { padding: 2.5rem; max-width: 1600px; margin: 0 auto; }
    .section-label {
      font-size: 0.68rem; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted);
      margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.75rem;
    }
    .section-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.25rem; }
    .card {
      background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden;
      animation: rise 0.45s cubic-bezier(0.16,1,0.3,1) both;
      transition: border-color 0.3s, box-shadow 0.3s, transform 0.3s;
      position: relative;
    }
    .card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, transparent, rgba(77,159,255,0.35), transparent);
      opacity: 0; transition: opacity 0.3s;
    }
    .card:hover { border-color: var(--border2); box-shadow: 0 8px 40px rgba(0,0,0,0.4); transform: translateY(-2px); }
    .card:hover::before { opacity: 1; }
    .card.crit { border-color: rgba(255,71,87,0.3); }
    .card.crit::before { background: linear-gradient(90deg, transparent, rgba(255,71,87,0.4), transparent); opacity: 1; }
    .card.warn { border-color: rgba(255,211,42,0.2); }
    @keyframes rise { from{opacity:0;transform:translateY(16px) scale(0.98)} to{opacity:1;transform:translateY(0) scale(1)} }
    .card-head { display: flex; align-items: center; justify-content: space-between; padding: 1.1rem 1.25rem 0.9rem; }
    .card-name {
      font-family: var(--font-h); font-size: 0.82rem; font-weight: 700;
      letter-spacing: 0.04em; text-transform: uppercase; color: var(--text);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 210px;
    }
    .badge {
      font-family: var(--font-h); font-size: 0.6rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase;
      padding: 0.2rem 0.6rem; border-radius: 20px; border: 1px solid; white-space: nowrap; flex-shrink: 0;
    }
    .badge.ok   { color: var(--green);  border-color: rgba(46,213,115,0.35);  background: rgba(46,213,115,0.08); }
    .badge.warn { color: var(--yellow); border-color: rgba(255,211,42,0.35);  background: rgba(255,211,42,0.08); }
    .badge.crit { color: var(--red);    border-color: rgba(255,71,87,0.35);   background: rgba(255,71,87,0.08); }
    .card-div { height: 1px; background: var(--border); margin: 0 1.25rem; }
    .stats { display: grid; grid-template-columns: 1fr 1fr 1fr; }
    .stat {
      padding: 1.2rem 0.75rem 1rem; border-right: 1px solid var(--border);
      display: flex; flex-direction: column; align-items: center; text-align: center; gap: 0.3rem;
    }
    .stat:last-child { border-right: none; }
    .stat-label { font-size: 0.6rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); }
    .stat-val { font-family: var(--font-h); font-size: 2.8rem; font-weight: 700; line-height: 1; letter-spacing: -0.02em; transition: color 0.4s; }
    .stat-unit { font-size: 0.62rem; color: var(--muted); font-weight: 400; }
    .c-yellow { color: var(--yellow); }
    .c-blue   { color: var(--blue); }
    .c-red    { color: var(--red); }
    .c-muted  { color: var(--muted2); }
    .card-foot {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.6rem 1.25rem; background: var(--surface2);
      border-top: 1px solid var(--border); font-size: 0.67rem; color: var(--muted);
    }
    .foot-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--green); display: inline-block; margin-right: 0.4rem; animation: pulse 2s ease-in-out infinite; }
    #auth-overlay {
      position: fixed; inset: 0; z-index: 200; background: var(--bg);
      background-image: radial-gradient(ellipse 60% 40% at 50% 40%, rgba(77,159,255,0.06) 0%, transparent 70%);
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1.5rem; padding: 2rem;
    }
    .auth-logo {
      width: 60px; height: 60px; border-radius: 16px;
      background: linear-gradient(135deg, #4d9fff 0%, #2563eb 100%);
      display: flex; align-items: center; justify-content: center; font-size: 1.7rem;
      box-shadow: 0 0 50px rgba(77,159,255,0.25); margin-bottom: 0.5rem;
    }
    #auth-overlay h1 { font-family: var(--font-h); font-size: 1.8rem; font-weight: 700; color: var(--text); }
    #auth-overlay p { color: var(--muted2); max-width: 380px; text-align: center; line-height: 1.8; font-size: 0.875rem; }
    .btn-auth {
      display: inline-flex; align-items: center; gap: 0.6rem;
      background: linear-gradient(135deg, #4d9fff 0%, #2563eb 100%);
      color: #fff; font-family: var(--font-h); font-size: 0.9rem; font-weight: 700; letter-spacing: 0.05em;
      padding: 0.85rem 2.5rem; border: none; border-radius: 10px; cursor: pointer; transition: all 0.2s;
      box-shadow: 0 4px 20px rgba(77,159,255,0.3);
    }
    .btn-auth:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(77,159,255,0.45); }
    #toast {
      position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 300;
      background: var(--surface2); border: 1px solid var(--border2); border-radius: 8px;
      padding: 0.75rem 1.1rem; font-size: 0.82rem; max-width: 300px;
      opacity: 0; transform: translateY(10px); transition: all 0.3s; pointer-events: none;
    }
    #toast.show { opacity: 1; transform: translateY(0); }
    #toast.err  { border-left: 3px solid var(--red); }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 4px; }
  </style>
</head>
<body>

<script>
const CONFIG = {
  CLIENT_ID: 'b08e2b01-639a-4723-a708-7e479696255f',
  REGION: 'usw2.pure.cloud',
  QUEUES: [
    { id: '4879c768-5ed5-4949-aff1-ccbb0e3dad99', label: 'Care Team POD1 Chat Queue' },
    { id: '0187e19e-f563-441e-ad62-2965f43de61f', label: 'Care Team POD1 Email Queue' },
    { id: '8aa2fa79-0bdb-4b2e-86f2-adce402a620c', label: 'Care Team POD1 Voice Queue' },
    { id: '17d0d069-2abe-4610-b21e-5b05e03996c2', label: 'Care Team Main Voice' },
  ],
  REFRESH_MS:       30000,
  WARN_WAITING:     5,
  CRIT_WAITING:     10,
  LONGEST_WAIT_RED: 300,
};
</script>

<header>
  <div class="brand">
    <div class="brand-icon">üì°</div>
    <div>
      <div class="brand-name">Queue Monitor</div>
      <div class="brand-sub">Live Dashboard</div>
    </div>
  </div>
  <div class="header-right">
    <div class="clock" id="clock">--:--:--</div>
    <div class="live-pill offline" id="live-badge">
      <span class="dot"></span>
      <span id="badge-text">OFFLINE</span>
    </div>
  </div>
</header>

<main>
  <div class="section-label">Real-time Queue Status</div>
  <div class="grid" id="grid">
    <div style="grid-column:1/-1;text-align:center;padding:5rem 2rem;color:var(--muted)">
      <div style="font-size:2rem;margin-bottom:1rem;opacity:0.3">‚è≥</div>
      <p>Connecting‚Ä¶</p>
    </div>
  </div>
</main>

<div id="auth-overlay" style="display:none">
  <div class="auth-logo">üì°</div>
  <h1>Queue Monitor</h1>
  <p>Sign in with your Genesys Cloud account to start monitoring queue statistics in real time.</p>
  <button class="btn-auth" onclick="doLogin()">üîê Sign in with Genesys Cloud</button>
</div>

<div id="toast"></div>

<script>
let token = null;
let timer = null;

setInterval(() => {
  document.getElementById('clock').textContent =
    new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}, 1000);

function buildAuthUrl() {
  const redirect = encodeURIComponent(window.location.href.split('#')[0]);
  return `https://login.${CONFIG.REGION}/oauth/authorize`
    + `?response_type=token`
    + `&client_id=${encodeURIComponent(CONFIG.CLIENT_ID)}`
    + `&redirect_uri=${redirect}`
    + `&scope=${encodeURIComponent('analytics:readonly routing:readonly')}`;
}
function doLogin() { window.location.href = buildAuthUrl(); }
function parseToken() {
  const hash = window.location.hash.substring(1);
  if (!hash) return null;
  return Object.fromEntries(new URLSearchParams(hash)).access_token || null;
}

async function api(path, opts = {}) {
  const r = await fetch(`https://api.${CONFIG.REGION}${path}`, {
    ...opts,
    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json', ...(opts.headers||{}) },
  });
  if (r.status === 401) { handleExpired(); throw new Error('401'); }
  if (!r.ok) throw new Error(`${r.status}`);
  return r.json();
}
function handleExpired() {
  token = null; clearInterval(timer);
  setBadge('error', 'SESSION EXPIRED');
  toast('Session expired ‚Äî please sign in again.', true);
  setTimeout(() => showAuth(), 2000);
}

async function getObservations() {
  const ids = CONFIG.QUEUES.map(q => q.id);
  const body = {
    filter: {
      type: 'and',
      clauses: [{ type: 'or', predicates: ids.map(id => ({ type: 'dimension', dimension: 'queueId', value: id })) }],
    },
    groupBy: ['queueId'],
    metrics: ['oWaiting', 'oInteracting', 'oAlerting', 'oLongestWaitingInteraction'],
  };
  const data = await api('/api/v2/analytics/queues/observations/query', { method: 'POST', body: JSON.stringify(body) });
  const map = {};
  for (const row of (data.results || [])) {
    const qId = row.group?.queueId;
    if (!qId) continue;
    if (!map[qId]) map[qId] = { waiting: 0, interacting: 0, alerting: 0, longestWaitSec: 0 };
    for (const d of (row.data || [])) {
      if (d.metric === 'oWaiting')                    map[qId].waiting     += d.stats?.count ?? 0;
      if (d.metric === 'oInteracting')                map[qId].interacting += d.stats?.count ?? 0;
      if (d.metric === 'oAlerting')                   map[qId].alerting    += d.stats?.count ?? 0;
      if (d.metric === 'oLongestWaitingInteraction') {
        const secs = Math.round((d.stats?.max ?? 0) / 1000);
        if (secs > map[qId].longestWaitSec) map[qId].longestWaitSec = secs;
      }
    }
  }
  return map;
}

async function getAgents(queueId) {
  try {
    const d = await api(`/api/v2/routing/queues/${queueId}/users?pageSize=50&pageNumber=1&joined=false&sortBy=name&sortOrder=asc&expand=presence`);
    return (d.entities || []).length;
  } catch { return null; }
}

async function poll() {
  try {
    const obs = await getObservations();
    const agentMap = {};
    await Promise.all(CONFIG.QUEUES.map(async q => { agentMap[q.id] = await getAgents(q.id); }));
    render(obs, agentMap);
    setBadge('live', 'LIVE');
  } catch (e) {
    if (e.message !== '401') { setBadge('error', 'ERROR'); toast('Fetch failed ‚Äî retrying shortly.', true); }
  }
}

function fmtTime(sec) {
  if (sec <= 0)   return { v: '0',                        u: 'sec' };
  if (sec < 60)   return { v: String(sec),                u: 'sec' };
  if (sec < 3600) return { v: String(Math.round(sec/60)), u: 'min' };
  return                 { v: (sec/3600).toFixed(1),      u: 'hr'  };
}

function health(waiting) {
  if (waiting >= CONFIG.CRIT_WAITING) return { label: 'CRITICAL', cls: 'crit' };
  if (waiting >= CONFIG.WARN_WAITING) return { label: 'WARNING',  cls: 'warn' };
  return                                     { label: 'HEALTHY',  cls: 'ok'   };
}

function render(obs, agents) {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  CONFIG.QUEUES.forEach((q, i) => {
    const o  = obs[q.id] || { waiting: 0, interacting: 0, longestWaitSec: 0 };
    const ag = agents[q.id] ?? '‚Äî';
    const h  = health(o.waiting);
    const lw = fmtTime(o.longestWaitSec);
    const lwRed = o.longestWaitSec >= CONFIG.LONGEST_WAIT_RED;
    const lwColor = lwRed ? 'c-red' : o.longestWaitSec > 0 ? 'c-yellow' : 'c-muted';
    const card = document.createElement('div');
    card.className = `card ${h.cls}`;
    card.style.animationDelay = `${i * 0.07}s`;
    card.innerHTML = `
      <div class="card-head">
        <div class="card-name" title="${esc(q.label)}">${esc(q.label)}</div>
        <div class="badge ${h.cls}">${h.label}</div>
      </div>
      <div class="card-div"></div>
      <div class="stats">
        <div class="stat">
          <div class="stat-label">Waiting</div>
          <div class="stat-val c-yellow">${o.waiting}</div>
          <div class="stat-unit">interactions</div>
        </div>
        <div class="stat">
          <div class="stat-label">Agents on Queue</div>
          <div class="stat-val c-blue">${ag}</div>
          <div class="stat-unit">staffed</div>
        </div>
        <div class="stat">
          <div class="stat-label">Longest Waiting</div>
          <div class="stat-val ${lwColor}">${lw.v}</div>
          <div class="stat-unit">${lw.u}</div>
        </div>
      </div>
      <div class="card-foot">
        <span><span class="foot-dot"></span>${o.interacting} active interaction${o.interacting !== 1 ? 's' : ''}</span>
        <span>Updates every ${CONFIG.REFRESH_MS/1000}s</span>
      </div>
    `;
    grid.appendChild(card);
  });
}

function setBadge(state, text) {
  const b = document.getElementById('live-badge');
  b.className = `live-pill ${state}`;
  b.querySelector('.dot').className = `dot ${state === 'live' ? 'pulse' : ''}`;
  document.getElementById('badge-text').textContent = text;
}
function showAuth() { document.getElementById('auth-overlay').style.display = 'flex'; }
function toast(msg, err = false) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'show' + (err ? ' err' : '');
  clearTimeout(t._timer); t._timer = setTimeout(() => t.className = '', 4000);
}
function esc(s) {
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

(function boot() {
  const t = parseToken();
  if (t) {
    token = t;
    history.replaceState(null, '', window.location.pathname);
    poll();
    timer = setInterval(poll, CONFIG.REFRESH_MS);
    return;
  }
  showAuth();
})();
</script>
</body>
</html>
