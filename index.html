<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Queue Monitor</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Inter+Tight:wght@500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg:        #060912;
      --surface:   #0c1220;
      --surface2:  #111828;
      --border:    #1a2640;
      --border2:   #223050;
      --blue:      #60a5fa;
      --cyan:      #22d3ee;
      --green:     #34d399;
      --orange:    #fb923c;
      --red:       #f87171;
      --text:      #f0f6ff;
      --muted:     #4a6380;
      --muted2:    #6b8aaa;
      --font-h:    'Inter Tight', sans-serif;
      --font-b:    'Inter', sans-serif;
      --radius:    16px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-b);
      min-height: 100vh;
      background-image:
        radial-gradient(ellipse 100% 60% at 20% -10%, rgba(96,165,250,0.06) 0%, transparent 55%),
        radial-gradient(ellipse 60% 40% at 80% 10%,  rgba(34,211,238,0.04) 0%, transparent 50%);
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 2.5rem; height: 66px;
      background: rgba(6,9,18,0.8);
      backdrop-filter: blur(24px);
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 50;
    }
    .brand { display: flex; align-items: center; gap: 0.9rem; }
    .brand-icon {
      width: 36px; height: 36px; border-radius: 10px;
      background: linear-gradient(135deg, #60a5fa 0%, #818cf8 100%);
      display: flex; align-items: center; justify-content: center; font-size: 1.05rem;
      box-shadow: 0 0 24px rgba(96,165,250,0.35);
    }
    .brand-text {}
    .brand-name { font-family: var(--font-h); font-size: 1.05rem; font-weight: 700; color: var(--text); letter-spacing: 0.01em; }
    .brand-sub  { font-size: 0.65rem; font-weight: 500; color: var(--muted2); letter-spacing: 0.1em; text-transform: uppercase; margin-top: 1px; }
    .header-right { display: flex; align-items: center; gap: 1.5rem; }
    .clock {
      font-family: var(--font-h); font-size: 1.05rem; font-weight: 600;
      color: var(--muted2); font-variant-numeric: tabular-nums; letter-spacing: 0.04em;
    }
    .live-pill {
      display: flex; align-items: center; gap: 0.5rem;
      font-family: var(--font-h); font-size: 0.68rem; font-weight: 700;
      letter-spacing: 0.1em; text-transform: uppercase;
      padding: 0.32rem 1rem; border-radius: 20px; border: 1px solid; transition: all 0.4s;
    }
    .live-pill.live    { color: var(--green); border-color: rgba(52,211,153,0.4); background: rgba(52,211,153,0.07); }
    .live-pill.offline { color: var(--muted); border-color: var(--border); background: transparent; }
    .live-pill.error   { color: var(--red);   border-color: rgba(248,113,113,0.4); background: rgba(248,113,113,0.07); }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; flex-shrink: 0; }
    .dot.pulse { animation: dotpulse 2s ease-in-out infinite; }
    @keyframes dotpulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.25;transform:scale(0.6)} }

    /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
    main { padding: 2.5rem; max-width: 1600px; margin: 0 auto; }
    .section-label {
      font-size: 0.65rem; font-weight: 600; letter-spacing: 0.14em; text-transform: uppercase;
      color: var(--muted); margin-bottom: 1.5rem;
      display: flex; align-items: center; gap: 0.75rem;
    }
    .section-label::after { content: ''; flex: 1; height: 1px; background: linear-gradient(90deg, var(--border), transparent); }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(310px, 1fr)); gap: 1.25rem; }

    /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      transition: border-color 0.4s, box-shadow 0.4s, transform 0.3s;
      position: relative;
    }
    /* first-load animation only on cards that have the .new class */
    .card.new { animation: rise 0.45s cubic-bezier(0.16,1,0.3,1) both; }
    @keyframes rise { from{opacity:0;transform:translateY(14px) scale(0.98)} to{opacity:1;transform:translateY(0) scale(1)} }

    .card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, transparent, rgba(96,165,250,0.4), transparent);
      opacity: 0; transition: opacity 0.3s;
    }
    .card:hover { border-color: var(--border2); box-shadow: 0 12px 48px rgba(0,0,0,0.5), 0 0 0 1px rgba(96,165,250,0.04); transform: translateY(-2px); }
    .card:hover::before { opacity: 1; }

    .card.crit { border-color: rgba(248,113,113,0.35); box-shadow: 0 0 30px rgba(248,113,113,0.06); }
    .card.crit::before { background: linear-gradient(90deg, transparent, rgba(248,113,113,0.5), transparent); opacity: 1; }
    .card.warn { border-color: rgba(251,146,60,0.3); }
    .card.no-agents { border-color: rgba(248,113,113,0.25); }

    /* ‚îÄ‚îÄ CARD HEADER ‚îÄ‚îÄ */
    .card-head {
      display: flex; align-items: center; justify-content: space-between;
      padding: 1.1rem 1.3rem 1rem;
    }
    .card-name {
      font-family: var(--font-h); font-size: 0.8rem; font-weight: 700;
      letter-spacing: 0.05em; text-transform: uppercase; color: var(--text);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;
    }
    .badge {
      font-family: var(--font-h); font-size: 0.58rem; font-weight: 700;
      letter-spacing: 0.1em; text-transform: uppercase;
      padding: 0.22rem 0.65rem; border-radius: 20px; border: 1px solid;
      white-space: nowrap; flex-shrink: 0; transition: all 0.4s;
    }
    .badge.ok        { color: var(--green);  border-color: rgba(52,211,153,0.4);   background: rgba(52,211,153,0.08); }
    .badge.warn      { color: var(--orange); border-color: rgba(251,146,60,0.4);   background: rgba(251,146,60,0.08); }
    .badge.crit      { color: var(--red);    border-color: rgba(248,113,113,0.4);  background: rgba(248,113,113,0.08); }
    .badge.no-agents {
      color: var(--red); border-color: rgba(248,113,113,0.5); background: rgba(248,113,113,0.1);
      animation: badgepulse 1.8s ease-in-out infinite;
    }
    @keyframes badgepulse {
      0%,100% { opacity:1; box-shadow: 0 0 0 0 rgba(248,113,113,0); }
      50%      { opacity:0.75; box-shadow: 0 0 0 4px rgba(248,113,113,0.15); }
    }

    /* ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ */
    .card-div { height: 1px; background: var(--border); margin: 0 1.3rem; }

    /* ‚îÄ‚îÄ STATS ‚Äî 3 columns ‚îÄ‚îÄ */
    .stats { display: grid; grid-template-columns: 1fr 1fr 1fr; }
    .stat {
      padding: 1.25rem 0.6rem 1.1rem;
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column; align-items: center; text-align: center; gap: 0.25rem;
    }
    .stat:last-child { border-right: none; }

    .stat-label {
      font-size: 0.6rem; font-weight: 600; letter-spacing: 0.12em;
      text-transform: uppercase; color: #b8d4ee;
    }
    .stat-val {
      font-family: var(--font-h); font-size: 2.9rem; font-weight: 700;
      line-height: 1; letter-spacing: -0.03em;
      transition: color 0.6s, opacity 0.3s;
    }
    .stat-unit {
      font-size: 0.62rem; color: #9ab8d4; font-weight: 500; letter-spacing: 0.06em;
    }

    /* number flash on update */
    @keyframes numflash { 0%{opacity:0.3;transform:scale(0.94)} 100%{opacity:1;transform:scale(1)} }
    .stat-val.flash { animation: numflash 0.35s cubic-bezier(0.16,1,0.3,1); }

    /* color classes */
    .c-blue      { color: var(--blue); }
    .c-red       { color: var(--red); }
    .c-green     { color: var(--green); }
    .c-slate     { color: #b8cce0; }

    /* zero-agents pulse */
    @keyframes agentpulse {
      0%,100% { opacity:1; text-shadow: 0 0 0px rgba(248,113,113,0); }
      50%      { opacity:0.55; text-shadow: 0 0 22px rgba(248,113,113,0.9); }
    }
    .c-agent-zero { color: var(--red); animation: agentpulse 1.6s ease-in-out infinite; }

    /* ‚îÄ‚îÄ CARD FOOTER ‚îÄ‚îÄ */
    .card-foot {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.65rem 1.3rem;
      background: rgba(0,0,0,0.15);
      border-top: 1px solid var(--border);
      font-size: 0.65rem; color: var(--muted);
    }
    .foot-left { display: flex; align-items: center; gap: 0.4rem; }
    .foot-dot  { width: 5px; height: 5px; border-radius: 50%; background: var(--green); animation: dotpulse 2s ease-in-out infinite; }

    /* ‚îÄ‚îÄ AUTH OVERLAY ‚îÄ‚îÄ */
    #auth-overlay {
      position: fixed; inset: 0; z-index: 200;
      background: var(--bg);
      background-image:
        radial-gradient(ellipse 70% 50% at 50% 35%, rgba(96,165,250,0.07) 0%, transparent 65%),
        radial-gradient(ellipse 40% 30% at 80% 70%, rgba(34,211,238,0.04) 0%, transparent 50%);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 1.5rem; padding: 2rem;
    }
    .auth-logo {
      width: 64px; height: 64px; border-radius: 18px;
      background: linear-gradient(135deg, #60a5fa 0%, #818cf8 100%);
      display: flex; align-items: center; justify-content: center; font-size: 1.8rem;
      box-shadow: 0 0 60px rgba(96,165,250,0.3); margin-bottom: 0.25rem;
    }
    #auth-overlay h1 {
      font-family: var(--font-h); font-size: 1.9rem; font-weight: 700;
      color: var(--text); letter-spacing: -0.01em;
    }
    #auth-overlay p { color: var(--muted2); max-width: 380px; text-align: center; line-height: 1.8; font-size: 0.875rem; }
    .btn-auth {
      display: inline-flex; align-items: center; gap: 0.6rem;
      background: linear-gradient(135deg, #60a5fa 0%, #818cf8 100%);
      color: #fff; font-family: var(--font-h); font-size: 0.9rem; font-weight: 700;
      letter-spacing: 0.04em; padding: 0.9rem 2.6rem; border: none; border-radius: 12px;
      cursor: pointer; transition: all 0.25s;
      box-shadow: 0 4px 24px rgba(96,165,250,0.35);
    }
    .btn-auth:hover { transform: translateY(-2px); box-shadow: 0 8px 36px rgba(96,165,250,0.5); }
    .btn-auth:active { transform: translateY(0); }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    #toast {
      position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 300;
      background: var(--surface2); border: 1px solid var(--border2); border-radius: 10px;
      padding: 0.8rem 1.2rem; font-size: 0.82rem; max-width: 300px;
      opacity: 0; transform: translateY(12px) scale(0.95);
      transition: all 0.3s cubic-bezier(0.16,1,0.3,1); pointer-events: none;
    }
    #toast.show { opacity: 1; transform: translateY(0) scale(1); }
    #toast.err  { border-left: 3px solid var(--red); }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 4px; }
  </style>
</head>
<body>

<script>
const CONFIG = {
  CLIENT_ID: 'b08e2b01-639a-4723-a708-7e479696255f',
  REGION: 'usw2.pure.cloud',
  QUEUES: [
    { id: '4879c768-5ed5-4949-aff1-ccbb0e3dad99', label: 'Care Team POD1 Chat Queue' },
    { id: '0187e19e-f563-441e-ad62-2965f43de61f', label: 'Care Team POD1 Email Queue' },
    { id: '8aa2fa79-0bdb-4b2e-86f2-adce402a620c', label: 'Care Team POD1 Voice Queue' },
    { id: '17d0d069-2abe-4610-b21e-5b05e03996c2', label: 'Care Team Main Voice' },
  ],
  REFRESH_MS:       60000,
  WARN_WAITING:     5,
  CRIT_WAITING:     10,
  LONGEST_WAIT_RED: 300,
};
</script>

<header>
  <div class="brand">
    <div class="brand-icon">üì°</div>
    <div class="brand-text">
      <div class="brand-name">Queue Monitor</div>
      <div class="brand-sub">Live Dashboard</div>
    </div>
  </div>
  <div class="header-right">
    <div class="clock" id="clock">--:--:--</div>
    <div class="live-pill offline" id="live-badge">
      <span class="dot"></span>
      <span id="badge-text">OFFLINE</span>
    </div>
  </div>
</header>

<main>
  <div class="section-label">Real-time Queue Status</div>
  <div class="grid" id="grid">
    <div style="grid-column:1/-1;text-align:center;padding:5rem 2rem;color:var(--muted)">
      <div style="font-size:2rem;margin-bottom:1rem;opacity:0.25">‚è≥</div>
      <div style="font-size:0.85rem">Connecting‚Ä¶</div>
    </div>
  </div>
</main>

<div id="auth-overlay" style="display:none">
  <div class="auth-logo">üì°</div>
  <h1>Queue Monitor</h1>
  <p>Sign in with your Genesys Cloud account to start monitoring queue statistics in real time.</p>
  <button class="btn-auth" onclick="doLogin()">üîê Sign in with Genesys Cloud</button>
</div>

<div id="toast"></div>

<script>
let token = null;
let timer = null;
let firstRender = true;

/* CLOCK */
setInterval(() => {
  document.getElementById('clock').textContent =
    new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}, 1000);

/* OAUTH */
function buildAuthUrl() {
  const redirect = encodeURIComponent(window.location.href.split('#')[0]);
  return `https://login.${CONFIG.REGION}/oauth/authorize`
    + `?response_type=token`
    + `&client_id=${encodeURIComponent(CONFIG.CLIENT_ID)}`
    + `&redirect_uri=${redirect}`
    + `&scope=${encodeURIComponent('analytics:readonly routing:readonly')}`;
}
function doLogin() { window.location.href = buildAuthUrl(); }
function parseToken() {
  const hash = window.location.hash.substring(1);
  if (!hash) return null;
  return Object.fromEntries(new URLSearchParams(hash)).access_token || null;
}

/* API */
async function api(path, opts = {}) {
  const r = await fetch(`https://api.${CONFIG.REGION}${path}`, {
    ...opts,
    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json', ...(opts.headers||{}) },
  });
  if (r.status === 401) { handleExpired(); throw new Error('401'); }
  if (!r.ok) throw new Error(`${r.status}`);
  return r.json();
}
function handleExpired() {
  token = null; clearInterval(timer);
  setBadge('error', 'SESSION EXPIRED');
  toast('Session expired ‚Äî please sign in again.', true);
  setTimeout(() => showAuth(), 2000);
}

/* OBSERVATIONS */
async function getObservations() {
  const ids = CONFIG.QUEUES.map(q => q.id);
  const body = {
    filter: {
      type: 'and',
      clauses: [{ type: 'or', predicates: ids.map(id => ({ type: 'dimension', dimension: 'queueId', value: id })) }],
    },
    groupBy: ['queueId'],
    metrics: ['oWaiting', 'oInteracting', 'oAlerting', 'oLongestWaiting'],
  };
  const data = await api('/api/v2/analytics/queues/observations/query', { method: 'POST', body: JSON.stringify(body) });
  const map = {};
  for (const row of (data.results || [])) {
    const qId = row.group?.queueId;
    if (!qId) continue;
    if (!map[qId]) map[qId] = { waiting: 0, interacting: 0, alerting: 0, longestWaitSec: 0 };
    for (const d of (row.data || [])) {
      if (d.metric === 'oLongestWaiting') {
        const startMs = d.stats?.calculatedMetricValue ?? 0;
        const secs = startMs > 0 ? Math.round((Date.now() - startMs) / 1000) : 0;
        if (secs > map[qId].longestWaitSec) map[qId].longestWaitSec = secs;
      }
      if (d.metric === 'oWaiting')     map[qId].waiting     += d.stats?.count ?? 0;
      if (d.metric === 'oInteracting') map[qId].interacting += d.stats?.count ?? 0;
      if (d.metric === 'oAlerting')    map[qId].alerting    += d.stats?.count ?? 0;
    }
  }
  return map;
}

/* AGENTS */
async function getAgents(queueId) {
  try {
    const d = await api(`/api/v2/routing/queues/${queueId}/users?pageSize=50&pageNumber=1&joined=false&sortBy=name&sortOrder=asc&expand=presence`);
    return (d.entities || []).length;
  } catch { return null; }
}

/* POLL */
async function poll() {
  try {
    const obs = await getObservations();
    const agentMap = {};
    await Promise.all(CONFIG.QUEUES.map(async q => { agentMap[q.id] = await getAgents(q.id); }));
    render(obs, agentMap);
    setBadge('live', 'LIVE');
  } catch (e) {
    if (e.message !== '401') { setBadge('error', 'ERROR'); toast('Fetch failed ‚Äî retrying shortly.', true); }
  }
}

/* FORMAT TIME */
function fmtTime(sec) {
  if (sec <= 0)   return { v: '0',                        u: 'sec' };
  if (sec < 60)   return { v: String(sec),                u: 'sec' };
  if (sec < 3600) return { v: String(Math.round(sec/60)), u: 'min' };
  return                 { v: (sec/3600).toFixed(1),      u: 'hr'  };
}

/* WAITING COLOR: white at 0, bright blue >0 */
function waitingColor(n) {
  if (n <= 0) return '#f0f6ff';  // white when zero
  return '#38bdf8';              // bright blue for any waiting
}

/* HEALTH */
function health(waiting, agents) {
  if (agents === 0 || agents === null) return { label: 'No Agents On-Queue', cls: 'no-agents' };
  if (waiting >= CONFIG.CRIT_WAITING)  return { label: 'Critical',           cls: 'crit' };
  if (waiting >= CONFIG.WARN_WAITING)  return { label: 'Warning',            cls: 'warn' };
  return                                      { label: 'Healthy',            cls: 'ok' };
}

/* SMOOTH UPDATE ‚Äî update stat values in place with a flash animation */
function updateStat(el, newVal, newUnit, newColorClass) {
  const valEl  = el.querySelector('.stat-val');
  const unitEl = el.querySelector('.stat-unit');
  if (!valEl || !unitEl) return;

  const oldVal = valEl.textContent;
  if (oldVal === String(newVal) && unitEl.textContent === newUnit) return; // no change

  // remove all color classes and re-add correct one
  valEl.className = `stat-val ${newColorClass}`;
  valEl.textContent = newVal;
  unitEl.textContent = newUnit;

  // trigger flash animation
  valEl.classList.remove('flash');
  void valEl.offsetWidth; // reflow
  valEl.classList.add('flash');
}

/* RENDER */
function render(obs, agents) {
  const grid = document.getElementById('grid');

  CONFIG.QUEUES.forEach((q, i) => {
    const o   = obs[q.id] || { waiting: 0, interacting: 0, longestWaitSec: 0 };
    const ag  = agents[q.id] ?? null;
    const agDisplay = ag === null ? '‚Äî' : String(ag);
    const h   = health(o.waiting, ag);
    const lw  = fmtTime(o.longestWaitSec);
    const lwRed = o.longestWaitSec >= CONFIG.LONGEST_WAIT_RED;
    const lwColor = 'c-slate';
    const agColor = (ag === null || agDisplay === '0') ? 'c-agent-zero' : 'c-blue';
    const wColor  = waitingColor(o.waiting);

    const cardId = `card-${q.id}`;
    let card = document.getElementById(cardId);

    if (!card) {
      // First time ‚Äî create the full card
      card = document.createElement('div');
      card.id = cardId;
      card.className = `card new ${h.cls}`;
      card.style.animationDelay = `${i * 0.08}s`;
      card.innerHTML = `
        <div class="card-head">
          <div class="card-name" title="${esc(q.label)}">${esc(q.label)}</div>
          <div class="badge ${h.cls}" id="badge-${q.id}">${h.label}</div>
        </div>
        <div class="card-div"></div>
        <div class="stats">
          <div class="stat" id="stat-waiting-${q.id}">
            <div class="stat-label">Waiting</div>
            <div class="stat-val" style="color:${wColor}">${o.waiting}</div>
            <div class="stat-unit">interactions</div>
          </div>
          <div class="stat" id="stat-agents-${q.id}">
            <div class="stat-label">Agents on Queue</div>
            <div class="stat-val ${agColor}">${agDisplay}</div>
            <div class="stat-unit">staffed</div>
          </div>
          <div class="stat" id="stat-longest-${q.id}">
            <div class="stat-label">Longest Waiting</div>
            <div class="stat-val ${lwColor}">${lw.v}</div>
            <div class="stat-unit">${lw.u}</div>
          </div>
        </div>
        <div class="card-foot">
          <div class="foot-left"><span class="foot-dot"></span><span id="foot-active-${q.id}">${o.interacting} active interaction${o.interacting !== 1 ? 's' : ''}</span></div>
          <span>Updates every ${CONFIG.REFRESH_MS/1000}s</span>
        </div>
      `;
      grid.appendChild(card);
    } else {
      // Subsequent renders ‚Äî update in place, no flicker
      card.className = `card ${h.cls}`;

      // Update badge
      const badge = document.getElementById(`badge-${q.id}`);
      if (badge) { badge.className = `badge ${h.cls}`; badge.textContent = h.label; }

      // Update stats smoothly
      const wEl = document.getElementById(`stat-waiting-${q.id}`)?.querySelector('.stat-val');
      if (wEl && wEl.textContent !== String(o.waiting)) {
        wEl.style.color = wColor;
        wEl.textContent = o.waiting;
        wEl.classList.remove('flash'); void wEl.offsetWidth; wEl.classList.add('flash');
      } else if (wEl) { wEl.style.color = wColor; }
      updateStat(document.getElementById(`stat-agents-${q.id}`),   agDisplay,   'staffed',      agColor);
      updateStat(document.getElementById(`stat-longest-${q.id}`),  lw.v,        lw.u,           lwColor);

      // Update footer
      const footActive = document.getElementById(`foot-active-${q.id}`);
      if (footActive) footActive.textContent = `${o.interacting} active interaction${o.interacting !== 1 ? 's' : ''}`;
    }
  });

  // Remove any cards for queues no longer in config
  [...grid.children].forEach(child => {
    if (child.id && child.id.startsWith('card-') && !CONFIG.QUEUES.find(q => `card-${q.id}` === child.id)) {
      child.remove();
    }
  });

  // Clear the loading placeholder on first render
  if (firstRender) {
    const placeholder = grid.querySelector('[style*="grid-column"]');
    if (placeholder) placeholder.remove();
    firstRender = false;
  }
}

/* UI HELPERS */
function setBadge(state, text) {
  const b = document.getElementById('live-badge');
  b.className = `live-pill ${state}`;
  b.querySelector('.dot').className = `dot ${state === 'live' ? 'pulse' : ''}`;
  document.getElementById('badge-text').textContent = text;
}
function showAuth() { document.getElementById('auth-overlay').style.display = 'flex'; }
function toast(msg, err = false) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'show' + (err ? ' err' : '');
  clearTimeout(t._timer); t._timer = setTimeout(() => t.className = '', 4000);
}
function esc(s) {
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* BOOT */
(function boot() {
  const t = parseToken();
  if (t) {
    token = t;
    history.replaceState(null, '', window.location.pathname);
    poll();
    timer = setInterval(poll, CONFIG.REFRESH_MS);
    return;
  }
  showAuth();
})();
</script>
</body>
</html>
